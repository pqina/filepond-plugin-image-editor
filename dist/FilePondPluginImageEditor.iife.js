var FilePondPluginImageEditor=function(){"use strict";const y=e=>e instanceof File,J=e=>/^image/.test(e.type),x=(e,o,g=[])=>{const T=document.createElement(e),E=Object.getOwnPropertyDescriptors(T.__proto__);for(const l in o)l==="style"?T.style.cssText=o[l]:E[l]&&E[l].set||/textContent|innerHTML/.test(l)||typeof o[l]=="function"?T[l]=o[l]:T.setAttribute(l,o[l]);return g.forEach(l=>T.appendChild(l)),T};let V=null;const S=()=>(V===null&&(V=typeof window<"u"&&typeof window.document<"u"),V),oe=S()&&!!Node.prototype.replaceChildren?(e,o)=>e.replaceChildren(o):(e,o)=>{for(;e.lastChild;)e.removeChild(e.lastChild);o!==void 0&&e.append(o)},v=S()&&x("div",{class:"PinturaMeasure",style:"position:absolute;left:0;top:0;width:99999px;height:0;pointer-events:none;contain:strict;margin:0;padding:0;"});let K;const re=e=>(oe(v,e),v.parentNode||document.body.append(v),clearTimeout(K),K=setTimeout(()=>{v.remove()},500),e);let j=null;const ae=()=>(j===null&&(j=S()&&/^((?!chrome|android).)*(safari|iphone|ipad)/i.test(navigator.userAgent)),j),se=e=>new Promise((o,g)=>{let T=!1;!e.parentNode&&ae()&&(T=!0,e.style.cssText="position:absolute;visibility:hidden;pointer-events:none;left:0;top:0;width:0;height:0;",re(e));const E=()=>{const P=e.naturalWidth,z=e.naturalHeight;P&&z&&(T&&e.remove(),clearInterval(l),o({width:P,height:z}))};e.onerror=P=>{clearInterval(l),g(P)};const l=setInterval(E,1);E()}),Ee=e=>new Promise((o,g)=>{const T=()=>{o({width:e.videoWidth,height:e.videoHeight})};if(e.readyState>=1)return T();e.onloadedmetadata=T,e.onerror=()=>g(e.error)}),de=e=>typeof e=="string",ce=e=>new Promise(o=>{const g=de(e)?e:URL.createObjectURL(e),T=()=>{const l=new Image;l.src=g,o(l)};if(e instanceof Blob&&J(e))return T();const E=document.createElement("video");E.preload="metadata",E.onloadedmetadata=()=>o(E),E.onerror=T,E.src=g}),le=e=>e.nodeName==="VIDEO",Ie=async e=>{let o;e.src?o=e:o=await ce(e);let g;try{g=le(o)?await Ee(o):await se(o)}finally{y(e)&&URL.revokeObjectURL(o.src)}return g},Y=e=>e instanceof Blob&&!(e instanceof File),X=(...e)=>{},Z=e=>{e.width=1,e.height=1;const o=e.getContext("2d");o&&o.clearRect(0,0,1,1)};let b=null;const _e=()=>{if(b===null)if("WebGL2RenderingContext"in window){let e;try{e=x("canvas"),b=!!e.getContext("webgl2")}catch{b=!1}e&&Z(e),e=void 0}else b=!1;return b},ue=(e,o)=>_e()?e.getContext("webgl2",o):e.getContext("webgl",o)||e.getContext("experimental-webgl",o);let H=null;const Te=()=>{if(H===null){let e=x("canvas");H=!!ue(e),Z(e),e=void 0}return H},fe=()=>Object.prototype.toString.call(window.operamini)==="[object OperaMini]",ge=()=>"Promise"in window,me=()=>"URL"in window&&"createObjectURL"in window.URL,pe=()=>"visibilityState"in document,Oe=()=>"performance"in window,Re=()=>"File"in window;let k=null;const q=()=>(k===null&&(k=S()&&!fe()&&pe()&&ge()&&Re()&&me()&&Oe()),k),ee=e=>{const{addFilter:o,utils:g,views:T}=e,{Type:E,createRoute:l}=g,{fileActionButton:P}=T,Q=(({parallel:i=1,autoShift:n=!0})=>{const r=[];let t=0;const s=()=>{if(!r.length)return f.oncomplete();t++,r.shift()(()=>{t--,t<i&&I()})},I=()=>{for(let _=0;_<i-t;_++)s()},f={queue:_=>{r.push(_),n&&I()},runJobs:I,oncomplete:()=>{}};return f})({parallel:1}),N=i=>i===null?{}:i;o("SHOULD_REMOVE_ON_REVERT",(i,{item:n,query:r})=>new Promise(t=>{const{file:s}=n,I=r("GET_ALLOW_IMAGE_EDITOR")&&r("GET_IMAGE_EDITOR_ALLOW_EDIT")&&r("GET_IMAGE_EDITOR_SUPPORT_EDIT")&&r("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(s);t(!I)})),o("DID_LOAD_ITEM",(i,{query:n,dispatch:r})=>new Promise((t,s)=>{if(i.origin>1){t(i);return}const{file:I}=i;if(!n("GET_ALLOW_IMAGE_EDITOR")||!n("GET_IMAGE_EDITOR_INSTANT_EDIT")||!n("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(I))return t(i);const f=()=>{if(!U.length)return;const{item:p,resolve:m,reject:O}=U[0];r("EDIT_ITEM",{id:p.id,handleEditorResponse:_(p,m,O)})},_=(p,m,O)=>h=>{U.shift(),h?m(p):O(p),r("KICK"),f()};he({item:i,resolve:t,reject:s}),U.length===1&&f()})),o("DID_CREATE_ITEM",(i,{query:n,dispatch:r})=>{i.getMetadata("color")&&i.setMetadata("colors",i.getMetadata("color")),i.extend("edit",()=>{r("EDIT_ITEM",{id:i.id})})});const U=[],he=i=>(U.push(i),i),Ge=i=>{const{imageProcessor:n,imageReader:r,imageWriter:t}=N(i("GET_IMAGE_EDITOR"));return i("GET_IMAGE_EDITOR_WRITE_IMAGE")&&i("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE")&&n&&r&&t},Ae=(i,n)=>{const r=i("GET_FILE_POSTER_HEIGHT"),t=i("GET_FILE_POSTER_MAX_HEIGHT");return r?(n.width=r*2,n.height=r*2):t&&(n.width=t*2,n.height=t*2),n},te=(i,n,r=()=>{})=>{if(!n)return;if(!i("GET_FILE_POSTER_FILTER_ITEM")(n))return r();const{imageProcessor:t,imageReader:s,imageWriter:I,editorOptions:f,legacyDataToImageState:_,imageState:p}=N(i("GET_IMAGE_EDITOR"));if(!t)return;const[m,O]=s,[h=X,L]=I,D=n.file,G=n.getMetadata("imageState"),w=Ae(i,{width:512,height:512}),C={...f,imageReader:m(O),imageWriter:h({...L||{},canvasMemoryLimit:w.width*w.height*2,preprocessImageState:(A,M,ie,B)=>!G&&_?{...A,..._(void 0,B.size,{...n.getMetadata()})}:A}),imageState:{...p,...G}};Q.queue(A=>{t(D,C).then(({dest:M})=>{n.setMetadata("poster",URL.createObjectURL(M),!0),A(),r()})})};o("CREATE_VIEW",i=>{const{is:n,view:r,query:t}=i;if(!t("GET_ALLOW_IMAGE_EDITOR")||!t("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE"))return;const s=t("GET_ALLOW_FILE_POSTER");if(!(n("file-info")&&!s||n("file")&&s))return;const{createEditor:f,imageReader:_,imageWriter:p,editorOptions:m,legacyDataToImageState:O,imageState:h}=N(t("GET_IMAGE_EDITOR"));if(!_||!p||!m||!m.locale)return;delete m.imageReader,delete m.imageWriter;const[L,D]=_,G=a=>{const{id:d}=a;return t("GET_ITEM",d)},w=a=>{if(!t("GET_ALLOW_FILE_POSTER"))return!1;const d=G(a);return d?t("GET_FILE_POSTER_FILTER_ITEM")(d)?!!d.getMetadata("poster"):!1:void 0},C=({root:a,props:d,action:c})=>{const{handleEditorResponse:u}=c,R=G(d),ne=y(R.file)||Y(R.file),Se=ne?R.file:R.source,F=f({...m,imageReader:L(D),src:Se});F.on("load",({size:$})=>{let W=R.getMetadata("imageState");!W&&O&&(W=O(F,$,R.getMetadata())),F.imageState={...h,...W}}),F.on("process",({src:$,imageState:W})=>{ne||R.setFile($),R.setMetadata("imageState",W),u&&u(!0)}),F.on("close",()=>{u&&u(!1)})},A=({root:a,props:d})=>{const{id:c}=d,u=t("GET_ITEM",c);if(!u)return;const R=u.file;t("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(R)&&(t("GET_ALLOW_FILE_POSTER")&&!u.getMetadata("poster")&&a.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:c}),!(!t("GET_IMAGE_EDITOR_ALLOW_EDIT")||!t("GET_IMAGE_EDITOR_SUPPORT_EDIT"))&&M(a,d))},M=(a,d)=>{if(a.ref.handleEdit||(a.ref.handleEdit=c=>{c.stopPropagation(),a.dispatch("EDIT_ITEM",{id:d.id})}),w(d)){a.ref.editButton&&a.ref.editButton.parentNode&&a.ref.editButton.parentNode.removeChild(a.ref.editButton);const c=r.createChildView(P,{label:"edit",icon:t("GET_IMAGE_EDITOR_ICON_EDIT"),opacity:0});c.element.classList.add("filepond--action-edit-item"),c.element.dataset.align=t("GET_STYLE_IMAGE_EDITOR_BUTTON_EDIT_ITEM_POSITION"),c.on("click",a.ref.handleEdit),a.ref.buttonEditItem=r.appendChildView(c)}else{a.ref.buttonEditItem&&a.removeChildView(a.ref.buttonEditItem);const c=r.element.querySelector(".filepond--file-info-main"),u=document.createElement("button");u.className="filepond--action-edit-item-alt",u.type="button",u.innerHTML=t("GET_IMAGE_EDITOR_ICON_EDIT")+"<span>edit</span>",u.addEventListener("click",a.ref.handleEdit),c.appendChild(u),a.ref.editButton=u}},ie=({root:a,props:d,action:c})=>{if(/imageState/.test(c.change.key)&&t("GET_ALLOW_FILE_POSTER"))return a.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:d.id});/poster/.test(c.change.key)&&(!t("GET_IMAGE_EDITOR_ALLOW_EDIT")||!t("GET_IMAGE_EDITOR_SUPPORT_EDIT")||M(a,d))};r.registerDestroyer(({root:a})=>{a.ref.buttonEditItem&&a.ref.buttonEditItem.off("click",a.ref.handleEdit),a.ref.editButton&&a.ref.editButton.removeEventListener("click",a.ref.handleEdit)});const B={EDIT_ITEM:C,DID_LOAD_ITEM:A,DID_UPDATE_ITEM_METADATA:ie,DID_REMOVE_ITEM:({props:a})=>{const{id:d}=a,c=t("GET_ITEM",d);if(!c)return;const u=c.getMetadata("poster");u&&URL.revokeObjectURL(u)},REQUEST_CREATE_IMAGE_POSTER:({root:a,props:d})=>te(a.query,G(d)),DID_FILE_POSTER_LOAD:void 0};if(s){const a=({root:d})=>{d.ref.buttonEditItem&&(d.ref.buttonEditItem.opacity=1)};B.DID_FILE_POSTER_LOAD=a}r.registerWriter(l(B))}),o("SHOULD_PREPARE_OUTPUT",(i,{query:n,change:r,item:t})=>new Promise(s=>{if(!n("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(t.file)||r&&!/imageState/.test(r.key))return s(!1);s(!n("IS_ASYNC"))}));const Me=(i,n,r)=>new Promise(t=>{if(!Ge(i)||r.archived||!y(n)&&!Y(n)||!i("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(n))return t(!1);Ie(n).then(()=>{const s=i("GET_IMAGE_TRANSFORM_IMAGE_FILTER");if(s){const I=s(n);if(typeof I=="boolean")return t(I);if(typeof I.then=="function")return I.then(t)}t(!0)}).catch(()=>{const s=i("GET_IMAGE_EDITOR_SUPPORT_IMAGE_FORMAT");if(s&&s(n)){t(!0);return}t(!1)})});return o("PREPARE_OUTPUT",(i,{query:n,item:r})=>{const t=s=>new Promise((I,f)=>{const _=()=>{Q.queue(p=>{const m=r.getMetadata("imageState"),{imageProcessor:O,imageReader:h,imageWriter:L,editorOptions:D,imageState:G}=N(n("GET_IMAGE_EDITOR"));if(!O||!h||!L||!D)return;const[w,C]=h,[A=X,M]=L;O(s,{...D,imageReader:w(C),imageWriter:A(M),imageState:{...G,...m}}).then(I).catch(f).finally(p)})};n("GET_ALLOW_FILE_POSTER")&&!r.getMetadata("poster")?te(n,r,_):_()});return new Promise(s=>{Me(n,i,r).then(I=>{if(!I)return s(i);t(i).then(f=>{const _=n("GET_IMAGE_EDITOR_AFTER_WRITE_IMAGE");if(_)return Promise.resolve(_(f)).then(s);s(f.dest)})})})}),{options:{allowImageEditor:[!0,E.BOOLEAN],imageEditorInstantEdit:[!1,E.BOOLEAN],imageEditorAllowEdit:[!0,E.BOOLEAN],imageEditorSupportEdit:[S()&&q()&&Te(),E.BOOLEAN],imageEditorSupportImage:[J,E.FUNCTION],imageEditorSupportImageFormat:[null,E.FUNCTION],imageEditorSupportWriteImage:[q(),E.BOOLEAN],imageEditorWriteImage:[!0,E.BOOLEAN],imageEditorBeforeOpenImage:[void 0,E.FUNCTION],imageEditorAfterWriteImage:[void 0,E.FUNCTION],imageEditor:[null,E.OBJECT],imageEditorIconEdit:['<svg width="26" height="26" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M8.5 17h1.586l7-7L15.5 8.414l-7 7V17zm-1.707-2.707l8-8a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-8 8A1 1 0 0 1 10.5 19h-3a1 1 0 0 1-1-1v-3a1 1 0 0 1 .293-.707z" fill="currentColor" fill-rule="nonzero"/></svg>',E.STRING],styleImageEditorButtonEditItemPosition:["bottom center",E.STRING]}}};return S()&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:ee})),ee}();
