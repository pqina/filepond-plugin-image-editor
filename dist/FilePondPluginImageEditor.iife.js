var FilePondPluginImageEditor=function(){"use strict";const $=e=>e instanceof File,J=e=>/^image/.test(e.type),N=(e,o,g=[])=>{const u=document.createElement(e),E=Object.getOwnPropertyDescriptors(u.__proto__);for(const l in o)l==="style"?u.style.cssText=o[l]:E[l]&&E[l].set||/textContent|innerHTML/.test(l)||typeof o[l]=="function"?u[l]=o[l]:u.setAttribute(l,o[l]);return g.forEach(l=>u.appendChild(l)),u};let y=null;const L=()=>(y===null&&(y=typeof window<"u"&&typeof window.document<"u"),y),ie=L()&&!!Node.prototype.replaceChildren?(e,o)=>e.replaceChildren(o):(e,o)=>{for(;e.lastChild;)e.removeChild(e.lastChild);o!==void 0&&e.append(o)},v=L()&&N("div",{class:"PinturaMeasure",style:"position:absolute;left:0;top:0;width:99999px;height:0;pointer-events:none;contain:strict;margin:0;padding:0;"});let K;const ne=e=>(ie(v,e),v.parentNode||document.body.append(v),clearTimeout(K),K=setTimeout(()=>{v.remove()},500),e);let x=null;const oe=()=>(x===null&&(x=L()&&/^((?!chrome|android).)*(safari|iphone|ipad)/i.test(navigator.userAgent)),x),re=e=>new Promise((o,g)=>{let u=!1;!e.parentNode&&oe()&&(u=!0,e.style.cssText="position:absolute;visibility:hidden;pointer-events:none;left:0;top:0;width:0;height:0;",ne(e));const E=()=>{const P=e.naturalWidth,H=e.naturalHeight;P&&H&&(u&&e.remove(),clearInterval(l),o({width:P,height:H}))};e.onerror=P=>{clearInterval(l),g(P)};const l=setInterval(E,1);E()}),ae=e=>new Promise((o,g)=>{const u=()=>{o({width:e.videoWidth,height:e.videoHeight})};if(e.readyState>=1)return u();e.onloadedmetadata=u,e.onerror=g}),se=e=>typeof e=="string",Ee=e=>new Promise(o=>{const g=se(e)?e:URL.createObjectURL(e),u=()=>{const l=new Image;l.src=g,o(l)};if(e instanceof Blob&&J(e))return u();const E=document.createElement("video");E.preload="metadata",E.onloadedmetadata=()=>o(E),E.onerror=u,E.src=g}),de=e=>e.nodeName==="VIDEO",ce=async e=>{let o;e.src?o=e:o=await Ee(e);let g;try{g=de(o)?await ae(o):await re(o)}finally{$(e)&&URL.revokeObjectURL(o.src)}return g},le=e=>e instanceof Blob&&!(e instanceof File),Y=(...e)=>{},X=e=>{e.width=1,e.height=1;const o=e.getContext("2d");o&&o.clearRect(0,0,1,1)};let b=null;const _e=()=>{if(b===null)if("WebGL2RenderingContext"in window){let e;try{e=N("canvas"),b=!!e.getContext("webgl2")}catch{b=!1}e&&X(e),e=void 0}else b=!1;return b},Ie=(e,o)=>_e()?e.getContext("webgl2",o):e.getContext("webgl",o)||e.getContext("experimental-webgl",o);let V=null;const ue=()=>{if(V===null){let e=N("canvas");V=!!Ie(e),X(e),e=void 0}return V},Te=()=>Object.prototype.toString.call(window.operamini)==="[object OperaMini]",fe=()=>"Promise"in window,ge=()=>"URL"in window&&"createObjectURL"in window.URL,me=()=>"visibilityState"in document,pe=()=>"performance"in window,Oe=()=>"File"in window;let j=null;const Z=()=>(j===null&&(j=L()&&!Te()&&me()&&fe()&&Oe()&&ge()&&pe()),j),q=e=>{const{addFilter:o,utils:g,views:u}=e,{Type:E,createRoute:l}=g,{fileActionButton:P}=u,k=(({parallel:i=1,autoShift:n=!0})=>{const r=[];let t=0;const s=()=>{if(!r.length)return f.oncomplete();t++,r.shift()(()=>{t--,t<i&&_()})},_=()=>{for(let I=0;I<i-t;I++)s()},f={queue:I=>{r.push(I),n&&_()},runJobs:_,oncomplete:()=>{}};return f})({parallel:1}),F=i=>i===null?{}:i;o("SHOULD_REMOVE_ON_REVERT",(i,{item:n,query:r})=>new Promise(t=>{const{file:s}=n,_=r("GET_ALLOW_IMAGE_EDITOR")&&r("GET_IMAGE_EDITOR_ALLOW_EDIT")&&r("GET_IMAGE_EDITOR_SUPPORT_EDIT")&&r("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(s);t(!_)})),o("DID_LOAD_ITEM",(i,{query:n,dispatch:r})=>new Promise((t,s)=>{if(i.origin>1){t(i);return}const{file:_}=i;if(!n("GET_ALLOW_IMAGE_EDITOR")||!n("GET_IMAGE_EDITOR_INSTANT_EDIT")||!n("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(_))return t(i);const f=()=>{if(!C.length)return;const{item:p,resolve:m,reject:O}=C[0];r("EDIT_ITEM",{id:p.id,handleEditorResponse:I(p,m,O)})},I=(p,m,O)=>R=>{C.shift(),R?m(p):O(p),r("KICK"),f()};Re({item:i,resolve:t,reject:s}),C.length===1&&f()})),o("DID_CREATE_ITEM",(i,{query:n,dispatch:r})=>{i.getMetadata("color")&&i.setMetadata("colors",i.getMetadata("color")),i.extend("edit",()=>{r("EDIT_ITEM",{id:i.id})})});const C=[],Re=i=>(C.push(i),i),he=i=>{const{imageProcessor:n,imageReader:r,imageWriter:t}=F(i("GET_IMAGE_EDITOR"));return i("GET_IMAGE_EDITOR_WRITE_IMAGE")&&i("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE")&&n&&r&&t},Ge=(i,n)=>{const r=i("GET_FILE_POSTER_HEIGHT"),t=i("GET_FILE_POSTER_MAX_HEIGHT");return r?(n.width=r*2,n.height=r*2):t&&(n.width=t*2,n.height=t*2),n},ee=(i,n,r=()=>{})=>{if(!n)return;if(!i("GET_FILE_POSTER_FILTER_ITEM")(n))return r();const{imageProcessor:t,imageReader:s,imageWriter:_,editorOptions:f,legacyDataToImageState:I,imageState:p}=F(i("GET_IMAGE_EDITOR"));if(!t)return;const[m,O]=s,[R=Y,S]=_,D=n.file,h=n.getMetadata("imageState"),w=Ge(i,{width:512,height:512}),U={...f,imageReader:m(O),imageWriter:R({...S||{},canvasMemoryLimit:w.width*w.height*2,preprocessImageState:(G,A,te,B)=>!h&&I?{...G,...I(void 0,B.size,{...n.getMetadata()})}:G}),imageState:{...p,...h}};k.queue(G=>{t(D,U).then(({dest:A})=>{n.setMetadata("poster",URL.createObjectURL(A),!0),G(),r()})})};o("CREATE_VIEW",i=>{const{is:n,view:r,query:t}=i;if(!t("GET_ALLOW_IMAGE_EDITOR")||!t("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE"))return;const s=t("GET_ALLOW_FILE_POSTER");if(!(n("file-info")&&!s||n("file")&&s))return;const{createEditor:f,imageReader:I,imageWriter:p,editorOptions:m,legacyDataToImageState:O,imageState:R}=F(t("GET_IMAGE_EDITOR"));if(!I||!p||!m||!m.locale)return;delete m.imageReader,delete m.imageWriter;const[S,D]=I,h=a=>{const{id:d}=a;return t("GET_ITEM",d)},w=a=>{if(!t("GET_ALLOW_FILE_POSTER"))return!1;const d=h(a);return d?t("GET_FILE_POSTER_FILTER_ITEM")(d)?!!d.getMetadata("poster"):!1:void 0},U=({root:a,props:d,action:c})=>{const{handleEditorResponse:T}=c,M=h(d),Me=M.file,W=f({...m,imageReader:S(D),src:Me});console.log("load editor",structuredClone(M.getMetadata())),W.on("load",({size:z})=>{let Q=M.getMetadata("imageState");!Q&&O&&(Q=O(W,z,M.getMetadata())),W.imageState={...R,...Q}}),W.on("process",({imageState:z})=>{M.setMetadata("imageState",z),T&&T(!0)}),W.on("close",()=>{T&&T(!1)})},G=({root:a,props:d})=>{const{id:c}=d,T=t("GET_ITEM",c);if(!T)return;const M=T.file;t("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(M)&&(t("GET_ALLOW_FILE_POSTER")&&!T.getMetadata("poster")&&a.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:c}),!(!t("GET_IMAGE_EDITOR_ALLOW_EDIT")||!t("GET_IMAGE_EDITOR_SUPPORT_EDIT"))&&A(a,d))},A=(a,d)=>{if(a.ref.handleEdit||(a.ref.handleEdit=c=>{c.stopPropagation(),a.dispatch("EDIT_ITEM",{id:d.id})}),w(d)){a.ref.editButton&&a.ref.editButton.parentNode&&a.ref.editButton.parentNode.removeChild(a.ref.editButton);const c=r.createChildView(P,{label:"edit",icon:t("GET_IMAGE_EDITOR_ICON_EDIT"),opacity:0});c.element.classList.add("filepond--action-edit-item"),c.element.dataset.align=t("GET_STYLE_IMAGE_EDITOR_BUTTON_EDIT_ITEM_POSITION"),c.on("click",a.ref.handleEdit),a.ref.buttonEditItem=r.appendChildView(c)}else{a.ref.buttonEditItem&&a.removeChildView(a.ref.buttonEditItem);const c=r.element.querySelector(".filepond--file-info-main"),T=document.createElement("button");T.className="filepond--action-edit-item-alt",T.innerHTML=t("GET_IMAGE_EDITOR_ICON_EDIT")+"<span>edit</span>",T.addEventListener("click",a.ref.handleEdit),c.appendChild(T),a.ref.editButton=T}},te=({root:a,props:d,action:c})=>{if(/imageState/.test(c.change.key)&&t("GET_ALLOW_FILE_POSTER"))return a.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:d.id});/poster/.test(c.change.key)&&(!t("GET_IMAGE_EDITOR_ALLOW_EDIT")||!t("GET_IMAGE_EDITOR_SUPPORT_EDIT")||A(a,d))};r.registerDestroyer(({root:a})=>{a.ref.buttonEditItem&&a.ref.buttonEditItem.off("click",a.ref.handleEdit),a.ref.editButton&&a.ref.editButton.removeEventListener("click",a.ref.handleEdit)});const B={EDIT_ITEM:U,DID_LOAD_ITEM:G,DID_UPDATE_ITEM_METADATA:te,DID_REMOVE_ITEM:({props:a})=>{const{id:d}=a,c=t("GET_ITEM",d);if(!c)return;const T=c.getMetadata("poster");T&&URL.revokeObjectURL(T)},REQUEST_CREATE_IMAGE_POSTER:({root:a,props:d})=>ee(a.query,h(d)),DID_FILE_POSTER_LOAD:void 0};if(s){const a=({root:d})=>{d.ref.buttonEditItem&&(d.ref.buttonEditItem.opacity=1)};B.DID_FILE_POSTER_LOAD=a}r.registerWriter(l(B))}),o("SHOULD_PREPARE_OUTPUT",(i,{query:n,change:r,item:t})=>new Promise(s=>{if(!n("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(t.file)||r&&!/imageState/.test(r.key))return s(!1);s(!n("IS_ASYNC"))}));const Ae=(i,n,r)=>new Promise(t=>{if(!he(i)||r.archived||!$(n)&&!le(n)||!i("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(n))return t(!1);ce(n).then(()=>{const s=i("GET_IMAGE_TRANSFORM_IMAGE_FILTER");if(s){const _=s(n);if(typeof _=="boolean")return t(_);if(typeof _.then=="function")return _.then(t)}t(!0)}).catch(()=>{t(!1)})});return o("PREPARE_OUTPUT",(i,{query:n,item:r})=>{const t=s=>new Promise((_,f)=>{const I=()=>{k.queue(p=>{const m=r.getMetadata("imageState"),{imageProcessor:O,imageReader:R,imageWriter:S,editorOptions:D,imageState:h}=F(n("GET_IMAGE_EDITOR"));if(!O||!R||!S||!D)return;const[w,U]=R,[G=Y,A]=S;O(s,{...D,imageReader:w(U),imageWriter:G(A),imageState:{...h,...m}}).then(_).catch(f).finally(p)})};n("GET_ALLOW_FILE_POSTER")&&!r.getMetadata("poster")?ee(n,r,I):I()});return new Promise(s=>{Ae(n,i,r).then(_=>{if(!_)return s(i);t(i).then(f=>{const I=n("GET_IMAGE_EDITOR_AFTER_WRITE_IMAGE");if(I)return Promise.resolve(I(f)).then(s);s(f.dest)})})})}),{options:{allowImageEditor:[!0,E.BOOLEAN],imageEditorInstantEdit:[!1,E.BOOLEAN],imageEditorAllowEdit:[!0,E.BOOLEAN],imageEditorSupportEdit:[L()&&Z()&&ue(),E.BOOLEAN],imageEditorSupportImage:[J,E.FUNCTION],imageEditorSupportWriteImage:[Z(),E.BOOLEAN],imageEditorWriteImage:[!0,E.BOOLEAN],imageEditorAfterWriteImage:[void 0,E.FUNCTION],imageEditor:[null,E.OBJECT],imageEditorIconEdit:['<svg width="26" height="26" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M8.5 17h1.586l7-7L15.5 8.414l-7 7V17zm-1.707-2.707l8-8a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-8 8A1 1 0 0 1 10.5 19h-3a1 1 0 0 1-1-1v-3a1 1 0 0 1 .293-.707z" fill="currentColor" fill-rule="nonzero"/></svg>',E.STRING],styleImageEditorButtonEditItemPosition:["bottom center",E.STRING]}}};return L()&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:q})),q}();
